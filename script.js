const storyTree = {
  "start": {
    "narrative": "The door to the hotel room clicks shut behind you, the sound echoing like a final verdict in a courtroom. The air is thick with the scent of cheap cologne and lingering cigarette smoke, the kind that clings to secrets and bad decisions. You, [protagonist-name], stand there in your rumpled detective coat, the badge on your belt feeling heavier than ever with each passing case. The fabric brushes against your skin, a reminder of the countless nights spent chasing shadows. Across the room, [partner-name] leans against the window, [partner-gender-pronoun] silhouette framed by the neon glow piercing through the grimy glass from the city below—a restless urban beast that never sleeps. [partner-name-pronoun] not the person you remember from the academy; [partner-gender-pronoun] features are hardened now, eyes shadowed by years of undercover work, carrying the weight of demons only the two of you understand. \"You shouldn't be here,\" [partner-name] murmurs, [partner-gender-pronoun] voice a low, gravelly rumble that sends a shiver racing down your spine, igniting a spark of forbidden familiarity. But you both know why you are. The case that bound you together—a relentless string of disappearances in the city's underbelly—has led to this charged moment, where the thin lines between duty and desire blur into a dangerous haze.\n\nThe room itself feels alive with history, a time capsule of forgotten nights: a king-sized bed with rumpled sheets that whisper tales of fleeting escapes, a mini-bar stocked with regrets in glass bottles, and a cracked mirror reflecting back the trauma you've both buried deep beneath your professional facades. Your heart races as you take a tentative step closer, the floorboards creaking under your boots like a countdown to an inevitable choice. [partner-name] turns slowly, [partner-gender-pronoun] gaze locking onto yours with an intensity that feels like a physical touch—unyielding, searching. \"We can't keep doing this, [protagonist-name],\" [partner-name] says, the words heavy with conflict, but [partner-gender-pronoun] hand reaches out, fingers brushing your arm with a touch that's both gentle and possessive, a silent plea wrapped in command. The addiction is mutual—the thrill of the chase, the obsession with justice, the trauma bond forged in the crucible of shared pain. It courses through you, a raw edge of emotion that makes every breath feel alive, every second dangerous. The city lights flicker outside, a restless sentinel of the world waiting to reclaim you, but in this room, it's just you and [partner-name], teetering on the brink of something unstoppable.\n\nYour mind drifts to the first time you met—partners on a high-stakes stakeout, adrenaline pumping as you took down a suspect in a rain-soaked alley. That night sparked something primal, a flame that burned through the rigid boundaries of professionalism, leaving scorch marks on your souls. Now, with the case closing in like a tightening noose, the obsession deepens, a magnetic pull that defies reason. [partner-name]'s breath is warm against your skin as [partner-name] leans in, [partner-gender-pronoun] lips hovering near your ear, the proximity sending a jolt through your nerves. \"One last time?\" [partner-name] whispers, the words dripping with bittersweet longing, a question that hangs in the air like smoke. Your mind races: the evidence you uncovered points to corruption festering higher up the chain, a truth that could destroy everything—including this fragile, intoxicating connection. The power-play between you is a intoxicating dance, a delicate balance of dominance and surrender that masks the underlying trauma etched into your shared history. Do you give in to the moment, or pull back to focus on the case that threatens to consume you both?",
    "choices": [
      {"text": "Give in to the moment and kiss [partner-name], letting passion take over.", "next": "kiss"},
      {"text": "Pull away and insist on discussing the case evidence first.", "next": "discuss"},
      {"text": "Suggest leaving the room to find a safer place to talk.", "next": "leave"}
    ]
  },
  "kiss": {
    "narrative": "The tension snaps like a taut wire, and you lean in, your lips meeting [partner-name]'s in a kiss that’s a volatile mix of desperation and unrestrained fire. [partner-gender-pronoun] hands slide around your waist with a possessive urgency, pulling you close until the heat between you ignites like dry tinder catching a spark in a storm. The world beyond this room—the case, the corruption, the ever-looming danger—dissolves into a distant, muted hum, overshadowed by the deepening kiss that claims you both with a fervor that sends electric sparks coursing through your veins. Your detective coat slips to the floor, a discarded shield, as you press yourself against [partner-name], your fingers tangling in [partner-gender-pronoun] hair, the texture a grounding anchor in this whirlwind. The trauma bond pulses with a fierce intensity, a tangled web of shared pain and addiction that transforms every touch into a dual-edged blade of salvation and destruction. [partner-name]'s breath catches, ragged and raw, as [partner-name] pulls back just enough, [partner-gender-pronoun] forehead resting against yours, the closeness a fragile sanctuary. \"[protagonist-name],\" [partner-name] whispers, [partner-gender-pronoun] voice rough with a cocktail of emotion—desire, fear, and unspoken regret, \"you know this could ruin us both.\" Yet, there’s no trace of retreat in [partner-gender-pronoun] eyes; only a bittersweet hunger burns there, the same insatiable need that has drawn you back time and again.\n\nThe room seems to spin, the dim glow of the mini-bar casting long, dancing shadows that mimic the ghosts of your past missions across the walls. You feel the obsession creeping deeper—the way [partner-gender-pronoun] touch erases the relentless nightmares of the disappearances, the way [partner-gender-pronoun] presence turns the power-play into a game where victory is shared in every heated glance. But as the passion builds to a crescendo, a sharp knock at the door slices through the steamy haze like a blade. It’s soft yet insistent, a warning wrapped in politeness. [partner-name] tenses immediately, [partner-gender-pronoun] hand darting instinctively to the gun holstered at [partner-gender-pronoun] hip, the metal glinting faintly in the low light. \"That’s not room service,\" [partner-name] mutters, [partner-gender-pronoun] eyes narrowing with a predator’s focus. Your heart lurches into a frantic rhythm, the sensual fog lifting to reveal the stark reality: the case isn’t over, and someone out there knows you’re here. The trauma bond tugs at your soul, urging you to cling to this moment, but your detective instincts scream of impending danger, a shadow creeping closer with every second.",
    "choices": [
      {"text": "Ignore the knock and continue the intimate moment, locking the door.", "next": "ignore_knock"},
      {"text": "Answer the door cautiously, with [partner-name] covering you from behind.", "next": "answer_door"},
      {"text": "Grab your coat and suggest escaping through the window to avoid confrontation.", "next": "escape_window"}
    ]
  },
  "ignore_knock": {
    "narrative": "The knock reverberates through the room once more, but you steel yourself against it, your lips seeking [partner-name]'s again with renewed determination. The world outside this charged space—the relentless case, the creeping corruption, the ever-present danger—fades into a distant murmur, drowned out by the intoxicating heat of [partner-gender-pronoun] body pressed against yours. Your fingers fumble for the door lock, twisting it shut with a decisive click that feels like a declaration of defiance against the unknown threat beyond. [partner-name]'s low, throaty chuckle vibrates through you, [partner-gender-pronoun] fingers tracing the curve of your back with a possessive tenderness that guides you toward the bed. \"Reckless as ever, [protagonist-name],\" [partner-name] murmurs, [partner-gender-pronoun] voice a sultry blend of amusement and unrestrained desire that sends a thrill down your spine. The addiction surges, a trauma bond so potent it transforms the lurking danger into an aphrodisiac, heightening every sensation. The room’s cheap lamp casts a warm, flickering glow, its light weaving shadows that turn the space into a steamy cocoon of isolation, a sanctuary carved from the chaos of your shared past. Your coat lies abandoned on the floor, shirts unbuttoned in a fevered rush, the bittersweet taste of forbidden love mingling with the salt of sweat as your bodies entwine. For a fleeting moment, the case—the disappearances, the corruption—dissolves, replaced by the raw, unbridled intensity of this connection, a power-play where surrender and conquest blur into a single, intoxicating dance.\n\nBut as the passion reaches its peak, [partner-name]'s phone buzzes insistently on the nightstand, a jarring intrusion that shatters the illusion of safety. [partner-name] glances at it, [partner-gender-pronoun] expression shifting from ecstasy to a shadowed concern. \"It’s my handler,\" [partner-name] whispers, the word heavy with implication, pulling you back to the harsh edges of reality like a cold splash of water. The obsession wavers—do you trust [partner-name] enough to stay entwined in this moment, or is this the pivotal point where the trauma bond begins to unravel? The knock has ceased, leaving an eerie silence that amplifies the tension, a silent testament to the consequences your choices may unleash.",
    "choices": [
      {"text": "Insist on checking the phone message together, blending passion with caution.", "next": "check_phone"},
      {"text": "Push the phone away and pull [partner-name] back into the moment, letting desire override suspicion.", "next": "push_phone"},
      {"text": "Break away and listen at the door, prioritizing safety over intimacy.", "next": "listen_door"}
    ]
  },
  "discuss": {
    "narrative": "You pull back from [partner-name], your breath still uneven from the lingering heat, and raise a hand to pause the charged moment. \"We need to talk about the evidence,\" you say, your voice steady despite the tempest of emotions swirling within. [partner-name] exhales sharply, [partner-gender-pronoun] shoulders slumping as [partner-name] steps back, running a hand through [partner-gender-pronoun] disheveled hair with a gesture of reluctant resignation. The room’s oppressive warmth cools, the intimacy giving way to the stark weight of duty that has defined your partnership. You retrieve your coat from the floor, the fabric heavy with the dossier you’ve carried like a burden—photos of missing faces staring blankly, coded messages scribbled in haste, and a ledger hinting at corruption festering within the precinct’s upper echelons. [partner-name] watches as you spread the documents across the rumpled bed, [partner-gender-pronoun] expression shifting from frustration to a focused intensity that mirrors your own. \"This goes higher than we thought,\" [partner-name] mutters, [partner-gender-pronoun] finger tracing a name circled in red—a captain you both once trusted implicitly. The trauma bond hums beneath the surface, a shared history of sacrifice and survival that makes this betrayal cut deeper than any blade.\n\nThe knock at the door intrudes again, sharper and more demanding this time, and [partner-name]’s hand hovers near [partner-gender-pronoun] gun, a silent readiness etched into [partner-gender-pronoun] stance. You exchange a glance, the power-play of your partnership now a strategic dance on the edge of a knife. The evidence could be the key to saving lives or the noose that ends your careers, and the choice feels monumental with [partner-name]’s gaze locked on you, waiting for your lead. The air thickens with the weight of decision, the city’s neon pulse a distant heartbeat beyond the walls.",
    "choices": [
      {"text": "Demand [partner-name] help you analyze the evidence now, risking exposure.", "next": "analyze_evidence"},
      {"text": "Suggest hiding the evidence and resuming the intimacy later.", "next": "hide_evidence"},
      {"text": "Propose calling for backup to secure the room.", "next": "call_backup"}
    ]
  },
  "leave": {
    "narrative": "You step back, your voice steady as you suggest, \"We should find somewhere safer to talk.\" [partner-name] nods, [partner-gender-pronoun] expression a complex tapestry of relief and lingering concern, the heat of the moment giving way to a shared instinct for survival. The room’s oppressive air feels like a tightening trap now, the persistent knock at the door a relentless countdown to an unknown threat. You grab your coat, the dossier crinkling in your pocket like a whispered secret, and move toward the door with purpose, [partner-name] falling into step behind you, [partner-gender-pronoun] presence a steady anchor. The hallway beyond is dimly lit, the carpet worn thin by the tread of countless souls, each shadow a potential predator lurking in the gloom. [partner-name] keeps [partner-gender-pronoun] hand near [partner-gender-pronoun] gun, [partner-gender-pronoun] eyes scanning the darkness with the precision of a seasoned operative as you descend the creaking stairs.\n\nOutside, the cold night air hits you like a slap, sharpening your senses and clearing the last vestiges of the room’s intimacy. [partner-name] pulls you into the shelter of an alley, [partner-gender-pronoun] hand firm yet protective on your arm. \"We can’t go back there tonight,\" [partner-name] says, [partner-gender-pronoun] breath visible in the chill, a cloud of determination in the frigid air. The trauma bond lingers, a thread of connection woven through danger and desire, fueling your resolve. You spot a payphone across the street, its faint light a beacon in the urban wilderness—your only link to the outside world amidst this chaos. The distant wail of a siren adds urgency, a question mark hanging over whether it signals help or pursuit.",
    "choices": [
      {"text": "Use the payphone to call your precinct for support.", "next": "call_precinct"},
      {"text": "Suggest finding a safe house with [partner-name].", "next": "find_safehouse"},
      {"text": "Decide to confront whoever followed you back at the hotel.", "next": "confront_hotel"}
    ]
  },
  "answer_door": {
    "narrative": "You nod at [partner-name], whispering with resolve, \"I’ll answer it. Cover me.\" [partner-name] draws [partner-gender-pronoun] gun with a fluid motion, positioning [partner-gender-pronoun]self behind the door with the stealth of a shadow as you turn the lock with a steady hand. The knock comes again, insistent and sharp, and you open the door a cautious crack. A figure looms in the threshold—tall, shrouded in a trench coat that conceals [partner-gender-pronoun] features, the dim hallway light catching the glint of a badge. \"Detective [protagonist-name]?\" a gravelly voice intones, the sound rough like gravel underfoot. It’s Internal Affairs, but the timing feels suspiciously precise, a thread pulled too tight in the fabric of your case. [partner-name]’s eyes narrow, [partner-gender-pronoun] grip tightening on the weapon, a silent sentinel ready to act.\n\nThe room contracts around you, the steamy tension evaporating into a cold, professional standoff. The agent steps forward with deliberate intent, [partner-gender-pronoun] gaze flicking between you and [partner-name] with the scrutiny of a hawk. \"We’ve been tracking the corruption leak,\" [partner-gender-pronoun] says, the words dropping like stones, \"and it leads to this room.\" Your heart sinks into your stomach—the evidence tucked into your coat could implicate you both, a double-edged sword in this high-stakes game. [partner-name] shifts subtly, [partner-gender-pronoun] readiness a coiled spring. The air crackles with the weight of this confrontation, your next move critical.",
    "choices": [
      {"text": "Invite the agent in to discuss the evidence calmly.", "next": "invite_agent"},
      {"text": "Signal [partner-name] to detain the agent quietly.", "next": "detain_agent"},
      {"text": "Deny everything and ask for a warrant.", "next": "deny_warrant"}
    ]
  },
  "escape_window": {
    "narrative": "You grab your coat with a swift motion, whispering urgently, \"Let’s go out the window.\" [partner-name] nods with a flicker of agreement, [partner-gender-pronoun] eyes sharpening with focus as [partner-name] moves to the glass with practiced efficiency. The knock escalates into a pounding fist, a drumbeat of impending doom, and you both scramble to the window, pushing it open with a groan of rusted hinges. The fire escape creaks ominously under your weight, the cold metal biting into your palms as you descend, each step a gamble against the night. The city sprawls below, a labyrinth of alleys and flickering lights, offering both escape and peril in equal measure. [partner-name] leaps down beside you, [partner-gender-pronoun] breath visible in the crisp air, a testament to [partner-gender-pronoun] resolve.\n\nShouts erupt from the room above—someone has breached the door, their voices a chaotic hunt through the space you’ve just fled. [partner-name] pulls you deeper into the shadows of the alley, [partner-gender-pronoun] hand firm and protective on your arm, the touch a lifeline in this sudden flight. \"We need to move,\" [partner-name] says, [partner-gender-pronoun] voice taut with urgency, cutting through the night like a blade. The trauma bond fuels your synchronized escape, but the danger is a living thing, coiling around you. A siren wails in the distance, its cry a question—ally or adversary? The choice looms large, your next step a pivot in this unfolding drama.",
    "choices": [
      {"text": "Head toward the siren, hoping for ally support.", "next": "toward_siren"},
      {"text": "Dive deeper into the alley to evade pursuit.", "next": "deeper_alley"},
      {"text": "Find a vantage point to observe the hotel.", "next": "vantage_point"}
    ]
  },
  "check_phone": {
    "narrative": "You insist with a steady tone, \"Let’s check the message together.\" [partner-name] pauses, [partner-gender-pronoun] reluctance evident, then hands you the phone with a guarded expression, [partner-gender-pronoun] fingers brushing yours in a fleeting connection. The screen illuminates with a text from [partner-gender-pronoun] handler: \"Meet at safehouse. Evidence compromised. IA closing in.\" Your stomach twists into a knot—the corruption you’ve uncovered runs deeper than the shadows you’ve chased, a truth that could unravel everything. [partner-name] watches as you read, [partner-gender-pronoun] hand still warm from your earlier embrace, a silent anchor in this storm.\n\nThe room transforms into a potential trap, the locked door a fragile barrier against the encroaching threat. You share a look with [partner-name], the trauma bond tightening like a lifeline as you weigh the gravity of your next decision. The absence of the knock heightens the tension, a quiet that screams of impending action. The city beyond the window pulses with life, oblivious to your peril. What do you do?",
    "choices": [
      {"text": "Agree to meet at the safehouse immediately.", "next": "meet_safehouse"},
      {"text": "Suggest staying to gather more evidence first.", "next": "gather_evidence"},
      {"text": "Propose contacting IA directly to clear your names.", "next": "contact_IA"}
    ]
  },
  "push_phone": {
    "narrative": "You push the phone away with a determined gesture, pulling [partner-name] back into the heated moment. \"Not now,\" you murmur, your lips finding [partner-gender-pronoun] again with a hunger that defies the interruption. The buzz fades into the background as [partner-name] yields, [partner-gender-pronoun] hands resuming their exploration with a renewed urgency that reignites the fire between you. The room’s shadows deepen, the steamy tension reclaiming its dominion as you guide each other toward the bed, the creak of the frame a rhythm to your passion. The power-play intensifies, a dance of dominance and surrender that blurs the lines of control.\n\nBut the phone buzzes again, a relentless intruder, and [partner-name] pauses, [partner-gender-pronoun] breath heavy and labored. \"It’s important,\" [partner-name] says, [partner-gender-pronoun] voice strained with the weight of duty clashing with desire. The trauma bond wavers, a delicate balance between the pull of passion and the call of responsibility. The knock’s absence leaves a void filled with dread, a silent threat lurking just beyond the door. What do you do?",
    "choices": [
      {"text": "Reluctantly check the phone to appease [partner-name].", "next": "reluctant_check"},
      {"text": "Insist on continuing, ignoring the distraction.", "next": "insist_continue"},
      {"text": "Suggest a compromise—check it briefly then resume.", "next": "compromise_check"}
    ]
  },
  "listen_door": {
    "narrative": "You break away from [partner-name], your senses sharpening as you press your ear to the door. The silence presses in, heavy and expectant, broken only by the faint shuffle of footsteps retreating down the hall—a ghostly echo in the stillness. [partner-name] stands ready, [partner-gender-pronoun] gun still gripped tightly, [partner-gender-pronoun] eyes locked on you with a mix of trust and tension. The steamy haze lifts, replaced by the cold clarity of a detective’s instinct kicking into overdrive. You signal [partner-name] to remain silent, your breath held as you strain to catch any further sound.\n\nA muffled voice drifts back through the wood—a low mutter about a “wrong room,” the words tinged with frustration. [partner-name] lowers [partner-gender-pronoun] weapon slightly, but the air remains thick with unresolved danger. The trauma bond hums, a shared understanding of the stakes binding you together. The evidence in your coat feels like a live wire, its potential to shift the case’s outcome pulsing in your grip. The city’s neon pulse filters through the window, a distant lifeline. What do you do?",
    "choices": [
      {"text": "Wait and listen further to confirm safety.", "next": "wait_listen"},
      {"text": "Open the door to investigate the voice.", "next": "investigate_voice"},
      {"text": "Plan an escape route with [partner-name].", "next": "plan_escape"}
    ]
  }
  // Additional branches can be expanded as needed
};

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('story-setup-form');
  if (form) {
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        localStorage.setItem('storyConfig', JSON.stringify(data));
        sessionStorage.setItem('currentNode', 'start');
        window.location.href = 'engine_latest.html';
      } catch (error) {
        console.error('Error processing form:', error);
        alert('Something went wrong. Please try again.');
      }
    });
  }

  const storyContent = document.getElementById('story-content');
  const choicesDiv = document.getElementById('choices');
  const restartButton = document.getElementById('restart-button');

  if (storyContent && choicesDiv) {
    const config = JSON.parse(localStorage.getItem('storyConfig') || '{}');
    let currentNode = sessionStorage.getItem('currentNode') || 'start';

    // Ensure renderNode runs on page load
    if (!config || Object.keys(config).length === 0) {
      storyContent.innerHTML = '<p>No story configuration found. Please set up your adventure on the setup page.</p>';
      choicesDiv.innerHTML = '';
    } else {
      renderNode(currentNode, config);
    }

    choicesDiv.addEventListener('click', (event) => {
      if (event.target.tagName === 'BUTTON') {
        const next = event.target.dataset.next;
        sessionStorage.setItem('currentNode', next);
        renderNode(next, config);
      }
    });

    restartButton.addEventListener('click', () => {
      sessionStorage.removeItem('currentNode');
      localStorage.removeItem('storyConfig');
      window.location.href = 'setup_latest.html';
    });
    restartButton.style.display = 'block';
  }

  function renderNode(nodeId, config) {
    const node = storyTree[nodeId];
    if (!node) {
      storyContent.innerHTML = '<p>End of story. Thank you for playing!</p>';
      choicesDiv.innerHTML = '';
      return;
    }

    let narrative = node.narrative;
    narrative = narrative.replace('[protagonist-name]', config['protagonist-name'] || 'Traveler');
    narrative = narrative.replace('[partner-name]', config['partner-name'] || 'Partner');
    narrative = narrative.replace('[partner-gender-pronoun]', getPronoun(config['partner-gender'] || 'no-preference'));

    // Split narrative into paragraphs for staged reveal
    const paragraphs = narrative.split('\n\n');
    storyContent.innerHTML = ''; // Clear previous content
    let index = 0;

    function showNextParagraph() {
      if (index < paragraphs.length) {
        const p = document.createElement('p');
        p.textContent = paragraphs[index];
        p.style.opacity = '0';
        p.style.transition = 'opacity 1s';
        storyContent.appendChild(p);
        setTimeout(() => {
          p.style.opacity = '1';
        }, 50); // Slight delay for smooth fade
        index++;
        setTimeout(showNextParagraph, 3000); // 3-second delay between paragraphs
      } else {
        renderChoices(node.choices);
      }
    }

    showNextParagraph();

    function renderChoices(choices) {
      choicesDiv.innerHTML = '';
      choices.forEach((choice, idx) => {
        const button = document.createElement('button');
        button.textContent = choice.text;
        button.dataset.next = choice.next;
        button.classList.add('choice-button');
        button.style.background = 'linear-gradient(90deg, #E63946, #A31B2A)';
        button.style.padding = '1.2rem 2rem';
        button.style.margin = '0.5rem 0';
        button.style.border = 'none';
        button.style.borderRadius = '10px';
        button.style.color = '#F5E8C7';
        button.style.fontSize = '1.2rem';
        button.style.cursor = 'pointer';
        button.style.transition = 'transform 0.3s, box-shadow 0.3s';
        button.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
        button.onmouseover = () => {
          button.style.transform = 'scale(1.05)';
          button.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.3)';
        };
        button.onmouseout = () => {
          button.style.transform = 'scale(1)';
          button.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
        };
        choicesDiv.appendChild(button);
      });
    }
  }

  function getPronoun(gender) {
    switch (gender) {
      case 'male':
        return 'his';
      case 'female':
        return 'her';
      case 'no-preference':
      default:
        return 'their';
    }
  }
});