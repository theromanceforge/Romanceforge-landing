const storyTree = {
  "start": {
    "narrative": "The door to the hotel room clicks shut behind you, the sound echoing like a final verdict in a courtroom. The air is thick with the scent of cheap cologne and lingering cigarette smoke, the kind that clings to secrets and bad decisions. You, [protagonist-name], stand there in your rumpled detective coat, the badge on your belt feeling heavier than ever. Across the room, [partner-name] leans against the window, [partner-gender-pronoun] silhouette framed by the neon glow from the city below. [partner-name-pronoun] not the person you remember from the academy—hardened now, eyes shadowed by years of undercover work and the demons that come with it. \"You shouldn't be here,\" [partner-name] murmurs, [partner-gender-pronoun] voice a low rumble that sends a shiver down your spine. But you both know why you are. The case that bound you together—a string of disappearances in the city's underbelly—has led to this moment, where lines blur between duty and desire.\n\nThe room is a time capsule of forgotten nights: a king-sized bed with rumpled sheets, a mini-bar stocked with regrets, and a mirror that reflects back the trauma you've both buried. Your heart races as you step closer, the floorboards creaking under your boots. [partner-name] turns, [partner-gender-pronoun] gaze locking onto yours, intense and unyielding. \"We can't keep doing this, [protagonist-name],\" [partner-name] says, but [partner-gender-pronoun] hand reaches out, fingers brushing your arm with a touch that's both gentle and possessive. The addiction is mutual—the thrill of the chase, the obsession with justice, the trauma bond forged in the fires of shared pain. You feel the pull, the raw edge of emotion that makes everything feel alive, dangerous. The city lights flicker outside, a reminder of the world waiting, but in this room, it's just you and [partner-name], teetering on the brink.\n\nYou recall the first time you met—partners on a stakeout, adrenaline pumping as you took down a suspect. That night sparked something, a flame that burned through professional boundaries. Now, with the case closing in, the obsession deepens. [partner-name]'s breath is warm against your skin as [partner-name] pulls you closer, [partner-gender-pronoun] lips hovering near your ear. \"One last time?\" [partner-name] whispers, the words laced with bittersweet longing. Your mind races: the evidence you uncovered points to corruption higher up, but confronting it could destroy everything—including this fragile connection. The power-play between you is intoxicating, a dance of dominance and surrender that masks the underlying trauma. Do you give in to the moment, or pull back to focus on the case?",
    "choices": [
      {"text": "Give in to the moment and kiss [partner-name], letting passion take over.", "next": "kiss"},
      {"text": "Pull away and insist on discussing the case evidence first.", "next": "discuss"},
      {"text": "Suggest leaving the room to find a safer place to talk.", "next": "leave"}
    ]
  },
  "kiss": {
    "narrative": "The tension snaps like a taut wire, and you lean in, your lips meeting [partner-name]'s in a kiss that's equal parts desperation and fire. [partner-gender-pronoun] hands slide around your waist, pulling you close, the heat between you igniting like a match to dry tinder. The world outside—the case, the corruption, the looming danger—fades into a distant hum as the kiss deepens, [partner-gender-pronoun] mouth claiming yours with a possessiveness that sends sparks through your body. Your coat falls to the floor, forgotten, as you press against [partner-name], fingers tangling in [partner-gender-pronoun] hair. The trauma bond pulses stronger than ever, a mix of shared pain and addiction that makes every touch feel like salvation and destruction rolled into one. [partner-name]'s breath is ragged when [partner-name] pulls back slightly, [partner-gender-pronoun] forehead resting against yours. \"[protagonist-name],\" [partner-name] whispers, voice rough with emotion, \"you know this could ruin us both.\" But there's no regret in [partner-gender-pronoun] eyes, only the bittersweet hunger that has kept you coming back.\n\nThe room spins with the intensity of it all, the mini-bar light casting shadows that dance like ghosts from your past. You feel the obsession creeping in—the way [partner-gender-pronoun] touch erases the nightmares of the disappearances, the way [partner-gender-pronoun] presence makes the power-play feel like a game you both win. But even as the passion builds, a knock at the door shatters the moment. It's soft, insistent, like a warning. [partner-name] tenses, [partner-gender-pronoun] hand moving instinctively to the gun at [partner-gender-pronoun] hip. \"That's not room service,\" [partner-name] mutters, eyes narrowing. Your heart races again, the steamy haze clearing to reveal the reality: the case isn't over, and someone knows you're here. The trauma bond tugs at you, urging you to stay, but the detective in you senses danger.",
    "choices": [
      {"text": "Ignore the knock and continue the intimate moment, locking the door.", "next": "ignore_knock"},
      {"text": "Answer the door cautiously, with [partner-name] covering you from behind.", "next": "answer_door"},
      {"text": "Grab your coat and suggest escaping through the window to avoid confrontation.", "next": "escape_window"}
    ]
  },
  "ignore_knock": {
    "narrative": "The knock echoes again, but you push it from your mind, your lips finding [partner-name]'s once more. The world narrows to the heat of [partner-gender-pronoun] body against yours, the way [partner-gender-pronoun] hands roam with a familiarity that borders on possession. You fumble for the door lock, twisting it shut without breaking the kiss, the click a small act of defiance against whatever lurks outside. [partner-name]'s low chuckle vibrates through you, [partner-gender-pronoun] fingers tracing the curve of your back as [partner-name] guides you toward the bed. \"Reckless as ever, [protagonist-name],\" [partner-name] murmurs, [partner-gender-pronoun] voice laced with amusement and desire. The addiction surges, a trauma bond that makes the danger feel like foreplay. The room's cheap lamp casts warm shadows, turning the space into a cocoon of steamy isolation. Your coat is discarded, shirts unbuttoned in a frenzy of need, the bittersweet taste of forbidden love mingling with the salt of sweat. For a moment, the case—the disappearances, the corruption—fades, replaced by the raw intensity of this connection, a power-play where you both surrender and conquer.\n\nBut as things escalate, [partner-name]'s phone buzzes on the nightstand, shattering the illusion. [partner-name] glances at it, [partner-gender-pronoun] expression darkening. \"It's my handler,\" [partner-name] whispers, the word carrying a weight that pulls you back to reality. The obsession flickers—do you trust [partner-name] enough to stay, or is this the moment the trauma unravels? The knock has stopped, but the tension lingers, a reminder that your choices have consequences.",
    "choices": [
      {"text": "Insist on checking the phone message together, blending passion with caution.", "next": "check_phone"},
      {"text": "Push the phone away and pull [partner-name] back into the moment, letting desire override suspicion.", "next": "push_phone"},
      {"text": "Break away and listen at the door, prioritizing safety over intimacy.", "next": "listen_door"}
    ]
  },
  "discuss": {
    "narrative": "You pull back from [partner-name], your breath still uneven, and hold up a hand to pause the moment. \"We need to talk about the evidence,\" you say, your voice firm despite the lingering heat. [partner-name] sighs, [partner-gender-pronoun] shoulders slumping as [partner-name] steps away, running a hand through [partner-gender-pronoun] hair. The room feels colder now, the intimacy replaced by the weight of duty. You retrieve your coat from the floor, pulling out the dossier you’ve been carrying—photos of missing faces, coded messages, and a ledger hinting at corruption in the precinct. [partner-name] watches as you spread them across the bed, [partner-gender-pronoun] expression shifting from frustration to focus. \"This goes higher than we thought,\" [partner-name] mutters, pointing to a name circled in red—a captain you both trusted. The trauma bond hums beneath the surface, a shared history of sacrifice that makes this betrayal sting deeper.\n\nThe knock at the door comes again, sharper this time, and [partner-name]’s hand hovers near [partner-gender-pronoun] gun. You exchange a glance, the power-play of your partnership now a strategic dance. The evidence could save lives or end your careers, and the choice feels heavier with [partner-name]’s gaze on you. Do you push forward with the investigation, or let the moment’s tension pull you back?",
    "choices": [
      {"text": "Demand [partner-name] help you analyze the evidence now, risking exposure.", "next": "analyze_evidence"},
      {"text": "Suggest hiding the evidence and resuming the intimacy later.", "next": "hide_evidence"},
      {"text": "Propose calling for backup to secure the room.", "next": "call_backup"}
    ]
  },
  "leave": {
    "narrative": "You step back, your voice steady as you suggest, \"We should find somewhere safer to talk.\" [partner-name] nods, [partner-gender-pronoun] expression a mix of relief and concern. The room’s oppressive air feels like a trap now, the knock at the door a ticking clock. You grab your coat, the dossier crinkling in your pocket, and move toward the door, [partner-name] following close behind. The hallway is dimly lit, the carpet worn thin by countless footsteps, each shadow a potential threat. [partner-name] keeps [partner-gender-pronoun] hand near [partner-gender-pronoun] gun, [partner-gender-pronoun] eyes scanning as you descend the stairs. The neon city glow seeps through the lobby windows, a stark contrast to the intimacy you left behind.\n\nOutside, the cold air hits you, sharpening your senses. [partner-name] pulls you into an alley, [partner-gender-pronoun] voice low. \"We can’t go back there tonight,\" [partner-name] says, [partner-gender-pronoun] breath visible in the chill. The trauma bond lingers, a thread connecting you through danger and desire. You spot a payphone across the street—your only link to the outside world. What do you do?",
    "choices": [
      {"text": "Use the payphone to call your precinct for support.", "next": "call_precinct"},
      {"text": "Suggest finding a safe house with [partner-name].", "next": "find_safehouse"},
      {"text": "Decide to confront whoever followed you back at the hotel.", "next": "confront_hotel"}
    ]
  },
  "answer_door": {
    "narrative": "You nod at [partner-name], whispering, \"I’ll answer it. Cover me.\" [partner-name] draws [partner-gender-pronoun] gun silently, positioning [partner-gender-pronoun]self behind the door as you turn the lock. The knock comes again, insistent, and you open it a crack. A figure stands there—tall, shadowed, a trench coat concealing [partner-gender-pronoun] features. \"Detective [protagonist-name]?\" a gravelly voice asks, holding up a badge. It’s Internal Affairs, but the timing feels off. [partner-name]’s eyes narrow, [partner-gender-pronoun] grip tightening on the weapon.\n\nThe room feels smaller with this new presence, the steamy tension replaced by a cold professional edge. The agent steps forward, [partner-gender-pronoun] gaze flicking between you and [partner-name]. \"We’ve been tracking the corruption leak,\" [partner-gender-pronoun] says, \"and it leads to this room.\" Your heart sinks—the evidence in your coat could implicate you both. [partner-name] shifts, ready to act. What do you do?",
    "choices": [
      {"text": "Invite the agent in to discuss the evidence calmly.", "next": "invite_agent"},
      {"text": "Signal [partner-name] to detain the agent quietly.", "next": "detain_agent"},
      {"text": "Deny everything and ask for a warrant.", "next": "deny_warrant"}
    ]
  },
  "escape_window": {
    "narrative": "You grab your coat, whispering urgently, \"Let’s go out the window.\" [partner-name] nods, [partner-gender-pronoun] eyes sharp as [partner-name] moves to the glass. The knock grows louder, a fist pounding now, and you both scramble to the window, pushing it open. The fire escape creaks under your weight, the cold metal biting into your hands as you descend. The city sprawls below, a maze of alleys and lights, offering both escape and peril. [partner-name] leaps down beside you, [partner-gender-pronoun] breath visible in the night air.\n\nYou hear shouts from the room above—someone’s entered, searching. [partner-name] pulls you into the shadows, [partner-gender-pronoun] hand firm on your arm. \"We need to move,\" [partner-name] says, [partner-gender-pronoun] voice tense. The trauma bond fuels your resolve, but the danger is palpable. A siren wails in the distance—help or pursuit? What do you do?",
    "choices": [
      {"text": "Head toward the siren, hoping for ally support.", "next": "toward_siren"},
      {"text": "Dive deeper into the alley to evade pursuit.", "next": "deeper_alley"},
      {"text": "Find a vantage point to observe the hotel.", "next": "vantage_point"}
    ]
  },
  "check_phone": {
    "narrative": "You insist, \"Let’s check the message together.\" [partner-name] hesitates, then hands you the phone, [partner-gender-pronoun] expression guarded. The screen glows with a text from [partner-gender-pronoun] handler: \"Meet at safehouse. Evidence compromised. IA closing in.\" Your stomach drops—the corruption runs deeper than you thought. [partner-name] watches as you read, [partner-gender-pronoun] hand still warm from your earlier closeness.\n\nThe room feels like a trap now, the locked door a fragile shield. You share a look with [partner-name], the trauma bond tightening as you weigh your next move. The knock’s absence is more ominous than its presence. What do you do?",
    "choices": [
      {"text": "Agree to meet at the safehouse immediately.", "next": "meet_safehouse"},
      {"text": "Suggest staying to gather more evidence first.", "next": "gather_evidence"},
      {"text": "Propose contacting IA directly to clear your names.", "next": "contact_IA"}
    ]
  },
  "push_phone": {
    "narrative": "You push the phone away, pulling [partner-name] back into the moment. \"Not now,\" you murmur, your lips finding [partner-gender-pronoun] again. The buzz fades as [partner-name] yields, [partner-gender-pronoun] hands resuming their exploration with renewed urgency. The room’s shadows deepen, the steamy tension reclaiming its hold. Your coats are forgotten, the bed creaking under your weight as the power-play intensifies, a dance of dominance and surrender.\n\nBut the phone buzzes again, insistent, and [partner-name] pauses, [partner-gender-pronoun] breath heavy. \"It’s important,\" [partner-name] says, [partner-gender-pronoun] voice strained. The trauma bond wavers—passion versus duty. The knock’s absence leaves a void filled with dread. What do you do?",
    "choices": [
      {"text": "Reluctantly check the phone to appease [partner-name].", "next": "reluctant_check"},
      {"text": "Insist on continuing, ignoring the distraction.", "next": "insist_continue"},
      {"text": "Suggest a compromise—check it briefly then resume.", "next": "compromise_check"}
    ]
  },
  "listen_door": {
    "narrative": "You break away, pressing your ear to the door. The silence is heavy, broken only by faint footsteps retreating down the hall. [partner-name] stands ready, [partner-gender-pronoun] gun still in hand, [partner-gender-pronoun] eyes locked on you. The steamy haze lifts, replaced by the cold clarity of danger. You signal [partner-name] to stay quiet, your detective instincts kicking in as you listen for more.\n\nA muffled voice drifts back—someone muttering about a “wrong room.” [partner-name] lowers [partner-gender-pronoun] weapon slightly, but the tension remains. The trauma bond hums, a shared understanding of the stakes. The evidence in your coat feels like a live wire. What do you do?",
    "choices": [
      {"text": "Wait and listen further to confirm safety.", "next": "wait_listen"},
      {"text": "Open the door to investigate the voice.", "next": "investigate_voice"},
      {"text": "Plan an escape route with [partner-name].", "next": "plan_escape"}
    ]
  }
};

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('story-setup-form');
  if (form) {
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        localStorage.setItem('storyConfig', JSON.stringify(data));
        sessionStorage.setItem('currentNode', 'start');
        window.location.href = 'engine_latest.html';
      } catch (error) {
        console.error('Error processing form:', error);
        alert('Something went wrong. Please try again.');
      }
    });
  }

  const storyContent = document.getElementById('story-content');
  const choicesDiv = document.getElementById('choices');
  const restartButton = document.getElementById('restart-button');

  if (storyContent && choicesDiv) {
    const config = JSON.parse(localStorage.getItem('storyConfig') || '{}');
    let currentNode = sessionStorage.getItem('currentNode') || 'start';
    renderNode(currentNode, config);

    choicesDiv.addEventListener('click', (event) => {
      if (event.target.tagName === 'BUTTON') {
        const next = event.target.dataset.next;
        sessionStorage.setItem('currentNode', next);
        renderNode(next, config);
      }
    });

    restartButton.addEventListener('click', () => {
      sessionStorage.removeItem('currentNode');
      localStorage.removeItem('storyConfig');
      window.location.href = 'setup_latest.html';
    });
    restartButton.style.display = 'block';
  }

  function renderNode(nodeId, config) {
    const node = storyTree[nodeId];
    if (!node) {
      storyContent.innerHTML = '<p>End of story. Thank you for playing!</p>';
      choicesDiv.innerHTML = '';
      return;
    }

    let narrative = node.narrative;
    narrative = narrative.replace('[protagonist-name]', config['protagonist-name'] || 'Traveler');
    narrative = narrative.replace('[partner-name]', config['partner-name'] || 'Partner');
    narrative = narrative.replace('[partner-gender-pronoun]', getPronoun(config['partner-gender'] || 'no-preference'));

    // Split narrative into paragraphs for staged reveal
    const paragraphs = narrative.split('\n\n');
    storyContent.innerHTML = ''; // Clear previous content
    let index = 0;

    function showNextParagraph() {
      if (index < paragraphs.length) {
        const p = document.createElement('p');
        p.textContent = paragraphs[index];
        p.style.opacity = '0';
        p.style.transition = 'opacity 1s';
        storyContent.appendChild(p);
        setTimeout(() => {
          p.style.opacity = '1';
        }, 10);
        index++;
        setTimeout(showNextParagraph, 2000); // 2-second delay between paragraphs
      } else if (index === paragraphs.length) {
        renderChoices(node.choices);
      }
    }

    showNextParagraph();

    function renderChoices(choices) {
      choicesDiv.innerHTML = '';
      choices.forEach((choice, idx) => {
        const button = document.createElement('button');
        button.textContent = choice.text;
        button.dataset.next = choice.next;
        button.classList.add('choice-button');
        button.style.animation = `fadeIn 0.5s ease forwards ${idx * 0.2}s`;
        choicesDiv.appendChild(button);
      });
    }
  }

  function getPronoun(gender) {
    if (gender === 'male') return 'his';
    if (gender === 'female') return 'her';
    return 'their';
  }
});